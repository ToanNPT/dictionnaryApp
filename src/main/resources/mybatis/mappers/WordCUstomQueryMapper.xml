<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.education.vndictionary.mybatisQuery.WordCustomQueryMapper">
    <resultMap id="WordResult" type="WordDto">
        <result column="id" property="id"/>
        <result column="key_work" property="keyWork"/>
        <result column="description" property="description"/>
        <result column="voice_id" property="voiceId"/>
        <result column="spelling" property="spelling"/>
        <result column="topic_id" property="topicId"/>
        <result column="topic_name" property="topicName"/>
        <result column="sec" property="sec"/>
        <result column="is_hidden" property="isHidden"/>
        <result column="path" property="voiceUrl"/>

        <result column="update_time" property="updateTime"/>
    </resultMap>

    <select id="searchWords" resultMap="WordResult">
        SELECT w.id, w.key_work, w.description, w.voice_id, w.spelling, w.topic_id, t.topic_name, w.sec, w.is_hidden,
        v.path, w.update_time
        FROM words w
        INNER JOIN topics t ON w.topic_id = t.id
        LEFT JOIN voices v ON w.voice_id = v.id
        WHERE w.is_hidden = false
        <if test="keyWork != '' ">
            AND LOWER(w.key_work) LIKE CONCAT('%', #{keyWork}, '%') OR LOWER(w.description) LIKE CONCAT('%', #{keyWork}, '%')
        </if>

        <if test="topicId != null ">
            AND w.topic_id = #{topicId}
        </if>

        <choose>
            <when test="dateOrder != null ">
                ORDER BY w.update_time #{dateOrder}
            </when>
            <otherwise>
                ORDER BY w.update_time DESC
            </otherwise>
        </choose>
        LIMIT #{limit}
        OFFSET #{offset}
    </select>

    <select id="countSearchWords" >
        SELECT COUNT(w.id)
        FROM words w
        INNER JOIN topics t ON w.topic_id = t.id
        LEFT JOIN voices v ON w.voice_id = v.id
        WHERE w.is_hidden = false
        <if test="keyWork != '' ">
            AND w.key_work LIKE CONCAT('%', #{keyWork}, '%')
        </if>

        <if test="topicId != null ">
            AND w.topic_id = #{topicId}
        </if>

    </select>



</mapper>